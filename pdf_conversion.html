<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CNIC Extractor 1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .content { padding: 30px; }
        .upload-section { text-align: center; margin-bottom: 30px; padding: 40px; border: 3px dashed #3498db; border-radius: 10px; background: #f8f9fa; transition: all 0.3s ease; }
        .upload-section:hover { border-color: #2980b9; background: #e8f4fc; }
        .upload-section h3 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5em; }
        .file-input { display: none; }
        .file-label { display: inline-block; background: #3498db; color: white; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 1.1em; transition: all 0.3s ease; margin: 10px; }
        .file-label:hover { background: #2980b9; transform: translateY(-2px); }
        .selected-file { margin-top: 15px; color: #27ae60; font-weight: bold; }
        .buttons { text-align: center; margin: 20px 0; }
        .btn { background: #e74c3c; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 1.1em; margin: 0 10px; transition: all 0.3s ease; }
        .btn:hover { background: #c0392b; transform: translateY(-2px); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }
        .btn-download { background: #27ae60; }
        .btn-download:hover { background: #219a52; }
        .progress-container { margin: 30px 0; text-align: center; }
        .progress-bar { width: 100%; height: 20px; background: #ecf0f1; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress { height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); width: 0%; transition: width 0.3s ease; }
        .status { text-align: center; padding: 15px; margin: 20px 0; border-radius: 8px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .results { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .results h3 { color: #2c3e50; margin-bottom: 15px; text-align: center; }
        .page-section { margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #3498db; }
        .page-header { color: #2c3e50; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .cnic-item { padding: 8px 12px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #27ae60; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 4px solid #3498db; }
        .stat-number { font-size: 2em; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .stat-label { color: #7f8c8d; font-size: 0.9em; }
        .instructions { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .instructions h4 { color: #856404; margin-bottom: 10px; }
        .instructions ul { list-style-position: inside; color: #856404; }
        .instructions li { margin: 5px 0; }
        .footer { text-align: center; padding: 20px; background: #2c3e50; color: white; margin-top: 30px; }
        .footer strong { color: #3498db; }
        @media (max-width: 768px) {
            .container { margin: 10px; }
            .header h1 { font-size: 2em; }
            .btn { display: block; width: 100%; margin: 10px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ CNIC Extractor</h1>
        </div>

        <div class="content">
            <!-- File Upload -->
            <div class="upload-section">
                <h3>üì§ Upload PDF File</h3>
                <input type="file" id="pdfFile" class="file-input" accept=".pdf">
                <label for="pdfFile" class="file-label">Choose PDF File</label>
                <div id="selectedFile" class="selected-file"></div>
            </div>

            <!-- Buttons -->
            <div class="buttons">
                <button id="extractBtn" class="btn" disabled>üîç Extract CNICs</button>
                <button id="downloadTxt" class="btn btn-download" disabled>üì• Download TXT</button>
                <button id="downloadCsv" class="btn btn-download" disabled>üìä Download CSV</button>
            </div>

            <!-- Progress -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div id="progressText">Ready to process</div>
            </div>

            <!-- Status -->
            <div id="status" class="status info">Please select a PDF file to begin extraction</div>

            <!-- Statistics -->
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalCnics">0</div>
                    <div class="stat-label">Total CNICs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueCnics">0</div>
                    <div class="stat-label">Unique CNICs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPages">0</div>
                    <div class="stat-label">Pages Processed</div>
                </div>
            </div>

            <!-- Results -->
            <div class="results" id="results" style="display: none;">
                <h3>üìã Extracted CNIC Numbers</h3>
                <div id="resultsContent"></div>
            </div>
        </div>

        <div class="footer">
            <strong>Developed by Muhammad Asif</strong> - CNIC Extractor
        </div>
    </div>

    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      // set worker
      if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
      }
    </script>

    <script>
    // ------------------- Real CNIC Extractor (hyphenated CNIC only) -------------------

    // Regex for hyphenated CNICs like 42101-1234567-5
    const CNIC_REGEX_HYPHEN = /\b\d{5}-\d{7}-\d\b/g;

    // State
    let currentData = null;
    let isProcessing = false;

    // Helpers
    function updateStatus(message, type = 'info') {
        const status = document.getElementById('status');
        if (!status) return;
        status.textContent = message;
        status.className = `status ${type}`;
    }

    function resetProgressAndResults() {
        const bar = document.getElementById('progressBar');
        const text = document.getElementById('progressText');
        if (bar) bar.style.width = '0%';
        if (text) text.textContent = 'Ready to process';
        const stats = document.getElementById('stats');
        const results = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        if (stats) stats.style.display = 'none';
        if (results) results.style.display = 'none';
        if (resultsContent) resultsContent.innerHTML = '';
        const dlTxt = document.getElementById('downloadTxt');
        const dlCsv = document.getElementById('downloadCsv');
        const extractBtn = document.getElementById('extractBtn');
        if (dlTxt) dlTxt.disabled = true;
        if (dlCsv) dlCsv.disabled = true;
        if (extractBtn) extractBtn.disabled = true;
    }

    // Extract text from a PDF file using pdf.js
    async function extractTextFromPDF(file) {
        if (typeof pdfjsLib === 'undefined') {
            throw new Error('pdfjsLib not found. Make sure PDF.js is loaded.');
        }

        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        const pdf = await loadingTask.promise;
        const numPages = pdf.numPages;
        const pages = [];

        for (let p = 1; p <= numPages; p++) {
            const page = await pdf.getPage(p);
            const textContent = await page.getTextContent();
            // join text fragments with spaces
            const pageText = textContent.items.map(i => i.str).join(' ');
            pages.push({ page: p, text: pageText });
        }

        return pages;
    }

    // Extract CNICs from a text string (hyphenated only)
    function extractCnicsFromText_Hyphen(text) {
        if (!text) return [];
        const matches = [];
        let m;
        while ((m = CNIC_REGEX_HYPHEN.exec(text)) !== null) {
            matches.push(m[0]);
        }
        return matches;
    }

    // Process file, extract CNICs page-by-page
    async function processFileAndExtract(file) {
        if (!file) throw new Error('No file provided.');
        isProcessing = true;
        updateStatus('Reading PDF and extracting text...', 'info');

        let pages;
        try {
            pages = await extractTextFromPDF(file);
        } catch (err) {
            isProcessing = false;
            throw err;
        }

        updateStatus('Scanning pages for CNIC patterns...', 'info');

        const cnicsByPage = {};            // page -> [ { cnic, count } ]
        const globalCounter = new Map();   // cnic -> total occurrences

        const totalPages = pages.length;

        for (let i = 0; i < pages.length; i++) {
            const { page, text } = pages[i];
            const rawMatches = extractCnicsFromText_Hyphen(text);
            // count per page
            const perPage = new Map();
            rawMatches.forEach(r => {
                const key = r.trim();
                perPage.set(key, (perPage.get(key) || 0) + 1);
                globalCounter.set(key, (globalCounter.get(key) || 0) + 1);
            });

            const arr = [];
            for (const [cnic, count] of perPage.entries()) {
                arr.push({ cnic, count });
            }
            cnicsByPage[page] = arr;

            // update progress UI
            const pct = Math.round(((i + 1) / totalPages) * 100);
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            if (progressBar) progressBar.style.width = `${pct}%`;
            if (progressText) progressText.textContent = `Processing... ${pct}%`;

            // tiny delay to keep UI responsive
            await new Promise(r => setTimeout(r, 10));
        }

        const totalOccurrences = Array.from(globalCounter.values()).reduce((a, b) => a + b, 0);
        const uniqueCnics = globalCounter.size;

        const data = {
            total_occurrences: totalOccurrences,
            unique_cnics: uniqueCnics,
            total_pages: totalPages,
            cnics_by_page: cnicsByPage
        };

        isProcessing = false;
        return data;
    }

    // UI wiring
    const pdfFileInput = document.getElementById('pdfFile');
    if (pdfFileInput) {
        pdfFileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('selectedFile').textContent = `Selected: ${file.name}`;
                document.getElementById('extractBtn').disabled = true;
                resetProgressAndResults();
                updateStatus('File selected. Click "Extract CNICs" to process.', 'info');
            } else {
                document.getElementById('selectedFile').textContent = '';
                updateStatus('Please select a PDF file to begin extraction', 'info');
                document.getElementById('extractBtn').disabled = true;
            }
        });
    }

    const extractBtn = document.getElementById('extractBtn');
    if (extractBtn) {
        extractBtn.addEventListener('click', async function () {
            if (isProcessing) return;
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput || !fileInput.files[0]) {
                updateStatus('Please select a PDF file first!', 'error');
                return;
            }

            try {
                extractBtn.disabled = true;
                document.getElementById('downloadTxt').disabled = true;
                document.getElementById('downloadCsv').disabled = true;
                updateStatus('Starting extraction...', 'info');

                const file = fileInput.files[0];
                const data = await processFileAndExtract(file);

                currentData = data;
                showResults(data);
                updateStatus('CNIC extraction completed successfully!', 'success');
                const progressText = document.getElementById('progressText');
                if (progressText) progressText.textContent = 'Processing complete!';
            } catch (err) {
                console.error(err);
                updateStatus(`Error: ${err.message || err}`, 'error');
                extractBtn.disabled = false;
            }
        });
    }

    // Render results into UI
    function showResults(data) {
        currentData = data;

        const stats = document.getElementById('stats');
        const results = document.getElementById('results');
        const totalCnicsEl = document.getElementById('totalCnics');
        const uniqueCnicsEl = document.getElementById('uniqueCnics');
        const totalPagesEl = document.getElementById('totalPages');
        const resultsContent = document.getElementById('resultsContent');

        if (stats) stats.style.display = 'grid';
        if (results) results.style.display = 'block';
        if (totalCnicsEl) totalCnicsEl.textContent = data.total_occurrences ?? 0;
        if (uniqueCnicsEl) uniqueCnicsEl.textContent = data.unique_cnics ?? 0;
        if (totalPagesEl) totalPagesEl.textContent = data.total_pages ?? 0;
        if (!resultsContent) return;

        // Sort pages numerically
        const pages = Object.keys(data.cnics_by_page || {})
            .map(p => parseInt(p, 10))
            .sort((a, b) => a - b);

        let html = '';
        let cumulative = 0;
        for (const page of pages) {
            const cnics = data.cnics_by_page[page] || [];
            html += `<div class="page-section"><div class="page-header">üìÑ Page ${page}</div>`;
            cnics.forEach((cnicInfo, idx) => {
                const serial = cumulative + idx + 1;
                html += `<div class="cnic-item"><strong>${serial}.</strong> ${cnicInfo.cnic}`;
                if (cnicInfo.count > 1) {
                    html += ` <small style="color: #e74c3c;"> (appears ${cnicInfo.count} times)</small>`;
                }
                html += `</div>`;
            });
            html += `</div>`;
            cumulative += cnics.length;
        }

        resultsContent.innerHTML = html;

        // enable downloads
        const dlTxt = document.getElementById('downloadTxt');
        const dlCsv = document.getElementById('downloadCsv');
        if (dlTxt) dlTxt.disabled = false;
        if (dlCsv) dlCsv.disabled = false;
    }

    // Download handlers
    document.getElementById('downloadTxt').addEventListener('click', function () {
        if (!currentData) {
            updateStatus('No data to download!', 'error');
            return;
        }

        let content = "EXTRACTED CNIC NUMBERS\n";
        content += "=".repeat(50) + "\n";
        content += `Extraction Date: ${new Date().toLocaleString()}\n`;
        content += `Total CNIC Occurrences: ${currentData.total_occurrences}\n`;
        content += `Unique CNICs: ${currentData.unique_cnics}\n`;
        content += "=".repeat(50) + "\n\n";

        const pages = Object.keys(currentData.cnics_by_page || {})
            .map(p => parseInt(p, 10))
            .sort((a, b) => a - b);

        for (const page of pages) {
            const cnics = currentData.cnics_by_page[page] || [];
            content += `PAGE ${page}:\n`;
            content += "-".repeat(40) + "\n";
            cnics.forEach((cnicInfo, index) => {
                const serial = pages.slice(0, pages.indexOf(page)).reduce((acc, p) => acc + (currentData.cnics_by_page[p] || []).length, 0) + index + 1;
                if (cnicInfo.count > 1) {
                    content += `${serial.toString().padStart(3)}. ${cnicInfo.cnic} (appears ${cnicInfo.count} times)\n`;
                } else {
                    content += `${serial.toString().padStart(3)}. ${cnicInfo.cnic}\n`;
                }
            });
            content += "\n";
        }

        content += "=".repeat(50) + "\n";
        content += "Developed by Muhammad Asif\n";

        downloadFile(content, 'cnics.txt', 'text/plain');
        updateStatus('TXT file downloaded successfully!', 'success');
    });

    document.getElementById('downloadCsv').addEventListener('click', function () {
        if (!currentData) {
            updateStatus('No data to download!', 'error');
            return;
        }

        let content = "SerialNo,CNICNumber,PageNumber,OccurrenceCount,ExtractionDate\n";
        let serial = 1;

        const pages = Object.keys(currentData.cnics_by_page || {})
            .map(p => parseInt(p, 10))
            .sort((a, b) => a - b);

        for (const page of pages) {
            const cnics = currentData.cnics_by_page[page] || [];
            cnics.forEach(cnicInfo => {
                // wrap CNIC in quotes in case of hyphens
                content += `${serial},"${cnicInfo.cnic}",${page},${cnicInfo.count},"${new Date().toLocaleString()}"\n`;
                serial++;
            });
        }

        downloadFile(content, 'cnics.csv', 'text/csv');
        updateStatus('CSV file downloaded successfully!', 'success');
    });

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        updateStatus('Welcome! Upload a PDF file to extract CNIC numbers.', 'info');
        document.getElementById('downloadTxt').disabled = true;
        document.getElementById('downloadCsv').disabled = true;
        document.getElementById('extractBtn').disabled = true;
    });
    </script>
</body>
</html>
